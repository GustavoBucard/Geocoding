<!DOCTYPE html>
<html>

<head>
  <title>Mapa Covid19 UFRJ</title>
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  <meta charset="utf-8">
  <style>
    #map {
      height: 100%;
    }

    html,
    body {
      height: 100%;
      padding-top: 1em;
    }

    .container {
      left: 10px;
      max-width: 95%;
      height: 30em;
      border: 2px solid #000000;
      padding: 2px;
      margin: auto;
    }
  </style>
</head>

<body>
  <div class='container'>
    <div id="map"></div>
  </div>
  <div>
    </br>
    <input style="margin-left: 45%;" text-align="center" value="Home" background-color="blue" type="button" />
  </div>
  <script>

    var geocoder;
    var map;
    var addressData = [{ location: "Ilha do Fundão, Rio de Janeiro" }, { location: "Gogó da Ema, Rio de Janeiro" }, { location: "Morro dos Macacos, Rio de Janeiro" }];

    function initMap() {
      var map = new google.maps.Map(
        document.getElementById("map"), {
          center: new google.maps.LatLng(-22.8576, -43.2004),
          zoom: 10,
          mapTypeId: google.maps.MapTypeId.ROADMAP
        });
      var coordinates = [{}];
      var geocoder = new google.maps.Geocoder();
      var bounds = new google.maps.LatLngBounds();

      function getEnderecos() {
        return new Promise(function (resolve, reject) {

          var xhr = new XMLHttpRequest();
          var url = 'http://' + window.location.host + '/ocorrencias/data'
          xhr.open("GET", url, true)
          xhr.onload = function (e) {
            var enderecos = JSON.parse(xhr.response).data
            resolve(enderecos)

          }
          xhr.send();
        })
      }

      function getLocations(enderecos) {
        var endereco_promises = []
        enderecos.forEach(e => {
          endereco_promises.push(new Promise(function (resolve, reject) {
            geocoder.geocode({
              'address': e
            }, function (results, status) {
              if (status === 'OK') {
                // console.log(results[0].geometry.location.lat());
                var result = new google.maps.LatLng(results[0].geometry.location.lat(), results[0].geometry.location.lng())
                resolve(result)
              } else {
                reject(new Error('Couldnt\'t find the location ' + e));
              }
            })
          }))
        })

        return endereco_promises
      }

      getEnderecos()
      .then(function (enderecos) {
        var locations = getLocations(enderecos)
        Promise.all(locations)
          .then(function (points) {
            var heatmap = new google.maps.visualization.HeatmapLayer({
              data: points,
              radius: 50,
              opacity: 0.4
            });

            heatmap.setMap(map);
          })
      })

    }

  </script>
  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBy5sPPL58np_vCYP9laO4QbJdH3WT71tc&libraries=places,visualization&callback=initMap">
    </script>
</body>

</html>